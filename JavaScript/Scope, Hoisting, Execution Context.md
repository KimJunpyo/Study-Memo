# Scope, Hoisting, Execution Context

Created: 2025년 5월 27일 오후 8:21
Tags: JS
Date: 2025년 5월 27일

## 스코프

변수에 접근할 수 있는 범위

## 렉시컬 환경

코드가 어디서 실행되고 주변에 어떤 코드가 있는지에 대한 정보

- 실행 컨텍스트는 실행할 코드에 제공할 환경 정보들을 모아놓은 객체이고, 그 핵심 구성 요소로 렉시컬 환경을 포함한다.

## 스코프 종류

전역, 지역, 동적, 렉시컬(정적)

## 스코프 체인

스코프들이 중첩 구조로 인해 계층적 구조로 연결된 것

```jsx
const x = 1;

const y = () => {
	const inner = 2;
	const z = () => {
		const inner2 = 3;
		console.log(inner2);
	}
	z();
	console.log(inner);
}
console.log(x);
y();
```

이러한 코드의 경우

전역 스코프의 식별자: x, y함수
y 함수 지역 스코프의 식별자: inner, z함수
스코프 체인: 전역 스코프 < y 함수 < z 함수

- 스코프 체인은 실행 컨텍스트의 렉시컬 환경을 단방향 연결한 것이다.
- 코드가 평가될 때, 전역 렉시컬 환경이 생성된다.
- 함수가 실행되면 해당 함수의 실행 컨텍스트와 지역 렉시컬 환경이 생성된다.

## 함수 레벨 스코프

함수의 코드 블록에서만 지역 스코프로 인정하는 특성

var 식별자의 경우 if, for, while 등 다양한 코드 블록 내에서는 지역 스코프를 생성하지 않고 해당 블록보다 상위 스코프를 지역 스코프로서 인정한다.

```jsx
var a = 1;

if(true) {
	var a = 3;
}
console.log(a); // 3;
```

- if 코드블록 내에서 a 변수를 var 식별자로 선언하였지만 if 문 밖에서 값을 확인해보면 a 변수의 값은 3이 된다.

## 렉시컬 스코프(정적 스코프)

함수가 정의된 위치에 따라 상위 스코프를 결정하는 것

```jsx
const x = 1;

const a = () => {
	const x = 10;
	b();
}

const b = () => {
	console.log(x);
}

a(); // 1;
b(); // 1;
```

JavaScript는 전체 코드를 평가한 뒤, 상단부터 순차적으로 코드를 실행시킨다.

코드를 평가할 때 식별자들을 평가하는 과정에서 실행 컨텍스트를 생성하고 환경 레코드에 등록한다.

b() 함수를 정의할 때의 상위 스코프는 전역 스코프이다.

따라서 b() 함수의 상위 스코프는 어디서 실행되든지에 관계없이 항상 전역 스코프이다.

## 호이스팅

변수의 선언을 코드의 최상단으로 끌어올리는 것처럼 동작하는 JavaScript의 특성

- 전체 코드를 평가할 때, 전역 실행 컨텍스트의 렉시컬 환경에 변수와 함수 등 식별자 선언문들을 저장한다.
- 코드 평가 시에 스코프 내의 모든 식별자들을 먼저 선언하기 때문에 해당 식별자들로의 접근이 가능하게 되는 것이다.
- var는 코드가 평가될 때, 메모리에 공간을 할당하고 초기화가 동작되어 undefined값을 갖게 된다.
이 때, var를 선언문 이전에 참조하면 undefined를 반환한다.
- let, const는 코드가 평가될 때, 메모리에 공간을 할당하고 초기화를 하지않는다.
두 식별자는 변수의 선언문이 실행될 때 undefined로 초기화가 동작된다.
선언문 이전에 let, const의 변수를 참조하면 reference error가 발생한다.
이 때, 변수가 메모리에 할당되고 초기화가 되지않아 참조할 수 없는 구간을 **TDZ(Temporal Dead Zone)** 일시적 사각지대라고 한다.

## 실행 컨텍스트

실행할 코드에 제공할 환경 정보들을 모아놓은 객체

## 콜 스택(실행 컨텍스트 스택)

실행 컨텍스트들을 코드의 실행 순서에 맞춰 관리하는 스택 자료구조

## 실행 컨텍스트 구성요소

- 렉시컬 환경
    - 환경 레코드
        - 객체 환경 레코드
            - Binding Object(전역 실행 컨텍스트)
                - window(전역 실행 컨텍스트)
        - 선언적 환경 레코드
            - let, const로 선언된 변수, arrow 함수들을 key-value로 관리
        - 실행 컨텍스트가 함수일 때엔 함수의 arguments, 선언된 변수, 매개변수 등을 관리
    - 외부 렉시컬 환경 참조
        - 상위 렉시컬 환경의 참조가 할당(메모리의 주소를 의미)
- this 바인딩: 실행 컨텍스트가 생성될 때 결정되며, 함수 호출 방식에 따라 값이 달라진다.

## 실행 컨텍스트의 특징

- 실행 컨텍스트에서 코드의 모든 정보들을 저장하고 코드가 실행되는 순서대로 콜스택(실행 컨텍스트 스택)에 순차적으로 저장되었다가 가장 마지막에 저장된 스택부터 차례차례 소멸한다.
- 실행 컨텍스트가 사라질 때 렉시컬 환경이 곧바로 사라지지 않고 존재하고 있다가 가비지 컬렉터에 의해 소멸한다.
- 그러나, 만약 실행 이후 소멸 과정에서 해당 실행 컨텍스트의 렉시컬 환경을 다른 실행 컨텍스트가 참조하고 있다면 해당 렉시컬 환경은 소멸하지 않는다.
이 경우는 내부 함수가 외부 함수의 지역 변수 등 상위 스코프의 환경 레코드에 존재하는 식별자에 접근하는 경우 발생한다.
즉, 내부 함수가 외부 함수의 실행이 끝난 뒤에도 외부 함수가 선언될때의 렉시컬 환경을 계속 참조할 수 있다.
이처럼 함수와 그 함수가 생성될 때의 렉시컬 환경의 조합을 클로저라고 한다.